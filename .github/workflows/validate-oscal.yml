name: Validate OSCAL Content

on:
  push:
    branches: [main]
    paths:
      - 'content/**'
      - '.github/workflows/validate-oscal.yml'
  pull_request:
    branches: [main]
    paths:
      - 'content/**'
      - '.github/workflows/validate-oscal.yml'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  validate:
    name: Validate OSCAL Documents
    runs-on: ubuntu-latest

    env:
      OSCAL_CLI_VERSION: "3.1.0"
      OSCAL_CLI_BASE_URL: "https://repo1.maven.org/maven2/dev/metaschema/oscal/oscal-cli-enhanced"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Download oscal-cli from Maven Central
        run: |
          curl -fsSL -o oscal-cli.zip \
            "${OSCAL_CLI_BASE_URL}/${OSCAL_CLI_VERSION}/oscal-cli-enhanced-${OSCAL_CLI_VERSION}-oscal-cli.zip"
          mkdir -p oscal-cli-install
          unzip -oq oscal-cli.zip -d oscal-cli-install
          CLI_BIN=$(find oscal-cli-install -name "oscal-cli" -type f | head -1)
          chmod +x "$CLI_BIN"
          echo "$(dirname "$CLI_BIN")" >> "$GITHUB_PATH"

      - name: Verify oscal-cli installation
        run: oscal-cli --version

      - name: Validate OSCAL content and generate SARIF
        run: |
          mkdir -p sarif-results
          file_count=0

          while IFS= read -r file; do
            sarif_name=$(echo "$file" | sed 's|^content/||; s|/|-|g; s|\.[^.]*$||')
            sarif_file="sarif-results/${sarif_name}.sarif"

            echo "::group::Validating ${file}"
            oscal-cli validate "$file" \
              -o "$sarif_file" \
              2>&1 || true
            echo "::endgroup::"

            file_count=$((file_count + 1))
          done < <(find content -type f \( -name '*.json' -o -name '*.xml' -o -name '*.yaml' \))

          echo "Validated ${file_count} files."

          # Ensure each SARIF file has a results array (required by upload-sarif)
          for sarif in sarif-results/*.sarif; do
            [ -f "$sarif" ] || continue
            if ! jq -e '.runs[0].results' "$sarif" > /dev/null 2>&1; then
              jq '.runs[0].results = []' "$sarif" > "${sarif}.tmp" && mv "${sarif}.tmp" "$sarif"
            fi
          done

          echo "Generated SARIF files:"
          ls -la sarif-results/

      - name: Upload SARIF results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('sarif-results/*.sarif') != ''
        with:
          sarif_file: sarif-results/
          category: oscal-validation
